<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>LEGO World Map Designing</title>
  <style type="text/css">
    body {
      margin: 0;
      padding: 0.5rem;
      font-family: sans-serif;
    }

    .controls > div {
      display: inline-block;
    }

    canvas {
      margin: 0.5rem 0;
      border: 5px solid grey;
    }
  </style>
</head>

<body>
  <h1>LEGO World Map Designer</h1>
  <div class="controls">
    <button type="button" id="togglePanels">Toggle Panels</button>
    <button type="button" id="toggleStuds">Toggle Studs</button>
    <div>
      <input type="radio" name="color" id="blue" value="blue">
      <label for="blue">Blue</label>
      <input type="radio" name="color" id="red" value="red">
      <label for="red">Red</label>
      <input type="radio" name="color" id="yellow" value="yellow">
      <label for="yellow">Yellow</label>
      <input type="radio" name="color" id="green" value="green">
      <label for="green">Green</label>
      <input type="radio" name="color" id="orange" value="orange">
      <label for="orange">Orange</label>
      <input type="radio" name="color" id="purple" value="purple" checked>
      <label for="purple">Purple</label>
    </div>
  </div>
  <canvas id="canvas" width="1280" height="800"></canvas>
  <h3>Created by <a href="https://github.com/ethan-arrowood">Ethan Arrowood</a> - <a href="">Source Code</a></h3>
  <script src="https://unpkg.com/xstate@4/dist/xstate.js"></script>
  <script type="module">
    const { createMachine, send, spawn, assign, interpret } = XState

    const canvas = document.getElementById('canvas')

    const STUD = {
      SIZE: 15,
    }

    const PANEL = {
      WIDTH: 16,
      HEIGHT: 16
    }

    const BOARD = {
      WIDTH: 8,
      HEIGHT: 5
    }

    const PANEL_WIDTH = PANEL.WIDTH * STUD.SIZE
    const PANEL_HEIGHT = PANEL.HEIGHT * STUD.SIZE

    const BOARD_WIDTH = BOARD.WIDTH * PANEL_WIDTH
    const BOARD_HEIGHT = BOARD.HEIGHT * PANEL_HEIGHT

    canvas.width = BOARD_WIDTH
    canvas.height = BOARD_HEIGHT

    if (canvas.getContext) {
      const ctx = canvas.getContext('2d')

      ctx.lineWidth = 2
      ctx.strokeStyle = 'black'
      ctx.fillRect(0, 0, BOARD_WIDTH, BOARD_HEIGHT)

      const studs = []
      const panels = []

      for (let x = 0; x < BOARD.WIDTH * PANEL.WIDTH; x++) {
        for (let y = 0; y < BOARD.HEIGHT * PANEL.HEIGHT; y++) {
          studs.push([
            x * STUD.SIZE,
            y * STUD.SIZE,
            STUD.SIZE,
            STUD.SIZE
          ])

          if (x % PANEL.WIDTH === 0 && y % PANEL.HEIGHT === 0) {
            panels.push([
              (x / PANEL.WIDTH) * PANEL_WIDTH,
              (y / PANEL.HEIGHT) * PANEL_HEIGHT,
              PANEL_WIDTH,
              PANEL_HEIGHT
            ])
          }
        }
      }

      function getSelectedColor () {
        return [...document.querySelectorAll('input[type=radio]')].find(e => e.checked).value
      }

      canvas.onclick = function ({ clientX, clientY }) {
        const { left, top } = canvas.getBoundingClientRect()

        const x = Math.round((clientX - left) / STUD.SIZE)
        const y = Math.round((clientY - top) / STUD.SIZE)

        ctx.fillStyle = getSelectedColor()
        // ctx.fillRect(
        //   ((x - 1) * STUD.SIZE) + 1,
        //   ((y - 1) * STUD.SIZE) + 1,
        //   STUD.SIZE - 2,
        //   STUD.SIZE - 2
        // )
        ctx.beginPath();
        ctx.arc(
          ((x - 1) * STUD.SIZE) + (STUD.SIZE / 2),
          ((y - 1) * STUD.SIZE) + (STUD.SIZE / 2),
          (STUD.SIZE - 2) / 2,
          0,
          2 * Math.PI
        )
        ctx.fill()
      }

      function drawItems(items) {
        for (const item of items) {
          ctx.strokeRect(...item)
        }
      }

      const boardMachine = createMachine({
        initial: "both_hidden",
        states: {
          both_hidden: {
            entry: ['hidePanels', 'hideStuds'],
            on: {
              SHOW_PANELS: {
                target: "panels_visible"
              },
              SHOW_STUDS: {
                target: "studs_visible"
              }
            }
          },
          panels_visible: {
            entry: ['hideStuds', 'showPanels'],
            on: {
              HIDE_PANELS: {
                target: "both_hidden"
              },
              SHOW_STUDS: {
                target: "both_visible"
              }
            }
          },
          studs_visible: {
            entry: ['hidePanels', 'showStuds'],
            on: {
              HIDE_STUDS: {
                target: "both_hidden"
              },
              SHOW_PANELS: {
                target: "both_visible"
              }
            }
          },
          both_visible: {
            entry: ['showStuds', 'showPanels'],
            on: {
              HIDE_STUDS: {
                target: "panels_visible"
              },
              HIDE_PANELS: {
                target: "studs_visible"
              }
            }
          }
        },
      }, {
        actions: {
          hidePanels: () => {
            ctx.strokeStyle = 'black'
            drawItems(panels)
          },
          hideStuds: () => {
            ctx.strokeStyle = 'black'
            drawItems(studs)
          },
          showPanels: () => {
            ctx.strokeStyle = 'white'
            drawItems(panels)
          },
          showStuds: () => {
            ctx.strokeStyle = 'white'
            drawItems(studs)
          }
        }
      });

      const boardService = interpret(boardMachine)

      boardService.start()

      document.getElementById('togglePanels').onclick = function togglePanels() {
        switch (boardService.state.value) {
          case 'both_hidden':
          case 'studs_visible':
            boardService.send('SHOW_PANELS')
            break
          case 'panels_visible':
          case 'both_visible':
            boardService.send('HIDE_PANELS')
            break
        }
      }

      document.getElementById('toggleStuds').onclick = function toggleStuds() {
        switch (boardService.state.value) {
          case 'both_hidden':
          case 'panels_visible':
            boardService.send('SHOW_STUDS')
            break
          case 'both_visible':
          case 'studs_visible':
            boardService.send('HIDE_STUDS')
            break
        }
      }

      
    }
  </script>
</body>

</html>